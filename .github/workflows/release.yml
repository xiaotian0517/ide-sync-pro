name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  release:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-2022
          - os: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Add macOS targets
        if: runner.os == 'macOS'
        run: |
          rustup target add aarch64-apple-darwin x86_64-apple-darwin

      - name: Install frontend deps
        run: npm ci

      - name: Build Tauri App (macOS)
        if: runner.os == 'macOS'
        shell: bash
        env:
          RAW_TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: |
          set -euo pipefail
          export TAURI_SIGNING_PRIVATE_KEY="$(printf '%s' "$RAW_TAURI_SIGNING_PRIVATE_KEY" | tr -d '\r\n')"
          export TAURI_SIGNING_PRIVATE_KEY_PASSWORD="${TAURI_SIGNING_PRIVATE_KEY_PASSWORD:-}"
          npm run tauri build -- --target universal-apple-darwin

      - name: Build Tauri App (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          RAW_TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: |
          $ErrorActionPreference = 'Stop'
          $sanitized = ($env:RAW_TAURI_SIGNING_PRIVATE_KEY -replace "(`r|`n)", '')
          $env:TAURI_SIGNING_PRIVATE_KEY = $sanitized
          if (-not $env:TAURI_SIGNING_PRIVATE_KEY_PASSWORD) { $env:TAURI_SIGNING_PRIVATE_KEY_PASSWORD = '' }
          npm run tauri build

      - name: Prepare macOS Assets
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p release-assets
          VERSION="${GITHUB_REF_NAME}"

          TAR_GZ=""; DMG=""
          for path in \
            "src-tauri/target/universal-apple-darwin/release/bundle/macos" \
            "src-tauri/target/aarch64-apple-darwin/release/bundle/macos" \
            "src-tauri/target/release/bundle/macos"; do
            if [ -d "$path" ]; then
              [ -z "$TAR_GZ" ] && TAR_GZ=$(find "$path" -maxdepth 1 -name "*.tar.gz" -type f | head -1 || true)
            fi
          done

          for path in \
            "src-tauri/target/universal-apple-darwin/release/bundle/dmg" \
            "src-tauri/target/aarch64-apple-darwin/release/bundle/dmg" \
            "src-tauri/target/release/bundle/dmg"; do
            if [ -d "$path" ]; then
              [ -z "$DMG" ] && DMG=$(find "$path" -maxdepth 1 -name "*.dmg" -type f | head -1 || true)
            fi
          done

          if [ -n "$TAR_GZ" ]; then
            NEW_TAR_GZ="IDE-Sync-Pro-${VERSION}-macOS.tar.gz"
            cp "$TAR_GZ" "release-assets/$NEW_TAR_GZ"
            [ -f "$TAR_GZ.sig" ] && cp "$TAR_GZ.sig" "release-assets/$NEW_TAR_GZ.sig"
            echo "macOS updater artifact: $NEW_TAR_GZ"
          fi

          if [ -n "$DMG" ]; then
            NEW_DMG="IDE-Sync-Pro-${VERSION}-macOS.dmg"
            cp "$DMG" "release-assets/$NEW_DMG"
            echo "macOS DMG: $NEW_DMG"
          fi

      - name: Prepare Windows Assets
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          New-Item -ItemType Directory -Force -Path release-assets | Out-Null
          $VERSION = $env:GITHUB_REF_NAME

          $msi = Get-ChildItem -Path 'src-tauri/target/release/bundle/msi' -Recurse -Include *.msi -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($null -ne $msi) {
            $dest = "IDE-Sync-Pro-$VERSION-Windows.msi"
            Copy-Item $msi.FullName (Join-Path release-assets $dest)
            Write-Host "MSI copied: $dest"
            $sigPath = "$($msi.FullName).sig"
            if (Test-Path $sigPath) {
              Copy-Item $sigPath (Join-Path release-assets "$dest.sig")
              Write-Host "Signature copied: $dest.sig"
            }
          }

          $nsis = Get-ChildItem -Path 'src-tauri/target/release/bundle/nsis' -Recurse -Include *.exe -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($null -ne $nsis) {
            $dest = "IDE-Sync-Pro-$VERSION-Windows-Setup.exe"
            Copy-Item $nsis.FullName (Join-Path release-assets $dest)
            Write-Host "NSIS copied: $dest"
          }

      - name: List prepared assets
        shell: bash
        run: ls -la release-assets || true

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: IDE Sync Pro ${{ github.ref_name }}
          draft: true
          prerelease: false
          body: |
            ## IDE Sync Pro ${{ github.ref_name }}

            跨 IDE 配置同步工具 - 支持 14+ VSCode 系编辑器

            ### 下载说明
            - **macOS**: 下载 `.dmg` 文件
            - **Windows**: 下载 `.msi`（安装版）或 `.exe`（Setup）

            ### macOS 提示
            首次打开如提示「已损坏」，请在终端执行：
            ```bash
            xattr -cr /Applications/IDE\ Sync\ Pro.app
            ```

            ### 更新内容
            详见 [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  assemble-latest-json:
    name: Assemble latest.json
    runs-on: ubuntu-22.04
    needs: release
    permissions:
      contents: write
    steps:
      - name: Download all release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          TAG="${GITHUB_REF_NAME}"
          mkdir -p dl
          gh release download "$TAG" --dir dl --repo "$GITHUB_REPOSITORY" || true
          ls -la dl || true

      - name: Generate latest.json
        env:
          REPO: ${{ github.repository }}
          TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          VERSION="${TAG#v}"
          PUB_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          base_url="https://github.com/$REPO/releases/download/$TAG"

          mac_url=""; mac_sig=""
          win_url=""; win_sig=""

          shopt -s nullglob
          for sig in dl/*.sig; do
            base=${sig%.sig}
            fname=$(basename "$base")
            url="$base_url/$fname"
            sig_content=$(cat "$sig")
            case "$fname" in
              *.tar.gz)
                mac_url="$url"; mac_sig="$sig_content";;
              *.msi)
                win_url="$url"; win_sig="$sig_content";;
            esac
          done

          tmp_json=$(mktemp)
          {
            echo '{'
            echo "  \"version\": \"$VERSION\","
            echo "  \"notes\": \"Release $TAG\","
            echo "  \"pub_date\": \"$PUB_DATE\","
            echo '  "platforms": {'
            first=1
            if [ -n "$mac_url" ] && [ -n "$mac_sig" ]; then
              for key in darwin-aarch64 darwin-x86_64; do
                [ $first -eq 0 ] && echo ','
                echo "    \"$key\": {\"signature\": \"$mac_sig\", \"url\": \"$mac_url\"}"
                first=0
              done
            fi
            if [ -n "$win_url" ] && [ -n "$win_sig" ]; then
              [ $first -eq 0 ] && echo ','
              echo "    \"windows-x86_64\": {\"signature\": \"$win_sig\", \"url\": \"$win_url\"}"
              first=0
            fi
            echo '  }'
            echo '}'
          } > "$tmp_json"
          echo "Generated latest.json:" && cat "$tmp_json"
          mv "$tmp_json" latest.json

      - name: Upload latest.json to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "$GITHUB_REF_NAME" latest.json --clobber --repo "$GITHUB_REPOSITORY" || true
